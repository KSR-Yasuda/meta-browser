From 35914254ef33743efa9861df4edcc9ec43f983d9 Mon Sep 17 00:00:00 2001
From: Martin Stransky <stransky@redhat.com>
Date: Tue, 11 Apr 2017 14:22:26 +0200
Subject: [PATCH 30/44] Force release unused back-buffers

Signed-off-by: Hiroshi Hatake <hatake@clear-code.com>
---
 widget/gtk/WindowSurfaceWayland.cpp | 9 +++++++--
 widget/gtk/WindowSurfaceWayland.h   | 3 ---
 2 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/widget/gtk/WindowSurfaceWayland.cpp b/widget/gtk/WindowSurfaceWayland.cpp
index 8b0ec3e4c3c6..f74ff61482b8 100644
--- a/widget/gtk/WindowSurfaceWayland.cpp
+++ b/widget/gtk/WindowSurfaceWayland.cpp
@@ -306,6 +306,8 @@ static const struct wl_buffer_listener buffer_listener = {
 
 void WindowBackBuffer::Create(int aWidth, int aHeight)
 {
+  MOZ_ASSERT(!IsAttached(), "We can't resize attached buffers.");
+
   int newBufferSize = aWidth*aHeight*BUFFER_BPP;
   mShmPool.Resize(newBufferSize);
 
@@ -469,10 +471,13 @@ WindowSurfaceWayland::GetBufferToDraw(int aWidth, int aHeight)
 
   // Front buffer is used by compositor, draw to back buffer
   if (mBackBuffer->IsAttached()) {
-      NS_ASSERTION(!mBackBuffer->IsAttached(), "We don't have any buffer to draw to!");
-      return nullptr;
+      NS_WARNING("Forced Wayland back-buffer release.");
+      mBackBuffer->Detach();
   }
 
+  MOZ_ASSERT(!mDelayedCommit,
+             "Unable to switch buffers waiting for commit.");
+
   WindowBackBuffer *tmp = mFrontBuffer;
   mFrontBuffer = mBackBuffer;
   mBackBuffer = tmp;
diff --git a/widget/gtk/WindowSurfaceWayland.h b/widget/gtk/WindowSurfaceWayland.h
index 375bd7e86b69..fbb1cfcfae7e 100644
--- a/widget/gtk/WindowSurfaceWayland.h
+++ b/widget/gtk/WindowSurfaceWayland.h
@@ -131,9 +131,6 @@ private:
   // we store the latest size request here to optimize
   // buffer usage and our gfx operations
   wl_surface*               mSurface;
-  int                       mWidth;
-  int                       mHeight;
-
   ImageBuffer               mImageBuffer;
 
   WindowBackBuffer*         mFrontBuffer;
-- 
2.11.0

