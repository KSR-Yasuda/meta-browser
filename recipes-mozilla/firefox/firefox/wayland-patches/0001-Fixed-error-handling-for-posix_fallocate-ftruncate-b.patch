From 2da37115290bcb9655225ab48e75ab65fc3049fb Mon Sep 17 00:00:00 2001
From: Martin Stransky <stransky@redhat.com>
Date: Thu, 22 Jun 2017 11:51:28 +0200
Subject: [PATCH 1/3] Fixed error handling for posix_fallocate/ftruncate, by
 Hiroshi Hatake

Signed-off-by: Hiroshi Hatake <hatake@clear-code.com>
---
 widget/gtk/WindowSurfaceWayland.cpp | 18 +++++++++++++++---
 1 file changed, 15 insertions(+), 3 deletions(-)

diff --git a/widget/gtk/WindowSurfaceWayland.cpp b/widget/gtk/WindowSurfaceWayland.cpp
index 9afbaeb47a3c..44aa825e1a58 100644
--- a/widget/gtk/WindowSurfaceWayland.cpp
+++ b/widget/gtk/WindowSurfaceWayland.cpp
@@ -20,6 +20,7 @@
 #include <sys/mman.h>
 #include <assert.h>
 #include <fcntl.h>
+#include <errno.h>
 
 namespace mozilla {
 namespace widget {
@@ -236,6 +237,7 @@ WaylandShmPool::CreateTemporaryFile(int aSize)
 
   char* filename;
   int fd = -1;
+  int ret = 0;
 
   if (tmpname.GetMutableData(&filename)) {
       fd = mkstemp(filename);
@@ -255,9 +257,19 @@ WaylandShmPool::CreateTemporaryFile(int aSize)
   }
 
 #ifdef HAVE_POSIX_FALLOCATE
-  int ret = posix_fallocate(fd, 0, aSize);
+  do {
+    ret = posix_fallocate(fd, 0, aSize);
+  } while (ret == EINTR);
+  if (ret != 0) {
+      close(fd);
+  }
 #else
-  int ret = ftruncate(fd, aSize);
+  do {
+      ret = ftruncate(fd, aSize);
+  } while (ret < 0 && errno == EINTR);
+  if (ret < 0) {
+      close(fd);
+  }
 #endif
   MOZ_RELEASE_ASSERT(ret == 0, "Mapping file allocation failed.");
 
@@ -300,7 +312,7 @@ WaylandShmPool::Resize(int aSize)
   munmap(mImageData, mAllocatedSize);
 
   mImageData = mmap(nullptr, aSize,
-                     PROT_READ | PROT_WRITE, MAP_SHARED, mShmPoolFd, 0);
+                    PROT_READ | PROT_WRITE, MAP_SHARED, mShmPoolFd, 0);
   if (mImageData == MAP_FAILED)
     return false;
 
-- 
2.11.0

