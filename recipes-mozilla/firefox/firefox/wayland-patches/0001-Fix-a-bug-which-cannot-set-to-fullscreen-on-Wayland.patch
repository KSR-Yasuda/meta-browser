From e6c042dbf4ead11d03ea67c60407575b1741c2b9 Mon Sep 17 00:00:00 2001
From: Takuro Ashie <ashie@clear-code.com>
Date: Fri, 26 May 2017 18:00:40 +0900
Subject: [PATCH] Fix a bug which cannot set to fullscreen on Wayland

Signed-off-by: Takuro Ashie <ashie@clear-code.com>
---
 widget/gtk/nsWindow.cpp | 16 +++++++++-------
 widget/gtk/nsWindow.h   |  1 +
 2 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/widget/gtk/nsWindow.cpp b/widget/gtk/nsWindow.cpp
index b881a876bf75..954c5a3e9948 100644
--- a/widget/gtk/nsWindow.cpp
+++ b/widget/gtk/nsWindow.cpp
@@ -5160,14 +5160,16 @@ nsWindow::PerformFullscreenTransition(FullscreenTransitionStage aStage,
                        transitionData, nullptr);
 }
 
-static bool
-IsFullscreenSupported(GtkWidget* aShell)
+bool
+nsWindow::IsFullscreenSupported()
 {
 #ifdef MOZ_X11
-    GdkScreen* screen = gtk_widget_get_screen(aShell);
-    GdkAtom atom = gdk_atom_intern("_NET_WM_STATE_FULLSCREEN", FALSE);
-    if (!gdk_x11_screen_supports_net_wm_hint(screen, atom)) {
-        return false;
+    if (mIsX11Display) {
+        GdkScreen* screen = gtk_widget_get_screen(mShell);
+        GdkAtom atom = gdk_atom_intern("_NET_WM_STATE_FULLSCREEN", FALSE);
+        if (!gdk_x11_screen_supports_net_wm_hint(screen, atom)) {
+            return false;
+        }
     }
 #endif
     return true;
@@ -5179,7 +5181,7 @@ nsWindow::MakeFullScreen(bool aFullScreen, nsIScreen* aTargetScreen)
     LOG(("nsWindow::MakeFullScreen [%p] aFullScreen %d\n",
          (void *)this, aFullScreen));
 
-    if (!IsFullscreenSupported(mShell)) {
+    if (!IsFullscreenSupported()) {
         return NS_ERROR_NOT_AVAILABLE;
     }
 
diff --git a/widget/gtk/nsWindow.h b/widget/gtk/nsWindow.h
index 8acf88bc6a53..7f25bcb86335 100644
--- a/widget/gtk/nsWindow.h
+++ b/widget/gtk/nsWindow.h
@@ -441,6 +441,7 @@ private:
                                    gint* aRootX, gint* aRootY);
     void               ClearCachedResources();
     nsIWidgetListener* GetListener();
+    bool               IsFullscreenSupported();
 
     GtkWidget          *mShell;
     MozContainer       *mContainer;
-- 
2.11.0

