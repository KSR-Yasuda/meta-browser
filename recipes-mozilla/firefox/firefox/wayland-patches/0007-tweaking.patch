From 0a795bf3a45380a1c82b699de1c3fa63a4d2f8f5 Mon Sep 17 00:00:00 2001
From: Martin Stransky <stransky@redhat.com>
Date: Mon, 24 Apr 2017 17:26:22 +0200
Subject: [PATCH 7/9] tweaking

Signed-off-by: Hiroshi Hatake <hatake@clear-code.com>
---
 toolkit/components/remote/DBusRemoteService.cpp  |  1 -
 toolkit/components/remote/nsGTKRemoteService.cpp | 19 +++++++++++++------
 toolkit/components/remote/nsGTKRemoteService.h   |  5 +++--
 3 files changed, 16 insertions(+), 9 deletions(-)

diff --git a/toolkit/components/remote/DBusRemoteService.cpp b/toolkit/components/remote/DBusRemoteService.cpp
index 5b3bc0c524de..b8e17fd91870 100644
--- a/toolkit/components/remote/DBusRemoteService.cpp
+++ b/toolkit/components/remote/DBusRemoteService.cpp
@@ -18,7 +18,6 @@
 #include "nsIWidget.h"
 #include "nsIAppShellService.h"
 #include "nsAppShellCID.h"
-#include "nsPrintfCString.h"
 
 #include <dbus/dbus.h>
 #include <dbus/dbus-glib-lowlevel.h>
diff --git a/toolkit/components/remote/nsGTKRemoteService.cpp b/toolkit/components/remote/nsGTKRemoteService.cpp
index 424b21cdb731..d72cf93a64f1 100644
--- a/toolkit/components/remote/nsGTKRemoteService.cpp
+++ b/toolkit/components/remote/nsGTKRemoteService.cpp
@@ -20,11 +20,17 @@
 #include "nsIWidget.h"
 #include "nsIAppShellService.h"
 #include "nsAppShellCID.h"
+#include "nsPrintfCString.h"
 
 #include "nsCOMPtr.h"
 
 #include "nsGTKToolkit.h"
 
+#ifdef ENABLE_REMOTE_DBUS
+#include <dbus/dbus.h>
+#include <dbus/dbus-glib-lowlevel.h>
+#endif
+
 NS_IMPL_ISUPPORTS(nsGTKRemoteService,
                   nsIRemoteService,
                   nsIObserver)
@@ -252,8 +258,9 @@ nsGTKRemoteService::HandleDBusMessage(DBusConnection *aConnection, DBusMessage *
 }
 
 void
-nsGTKRemoteService::UnregisterDBusInterface()
+nsGTKRemoteService::UnregisterDBusInterface(DBusConnection *aConnection)
 {
+  NS_ASSERTION(mConnection == aConnection, "Wrong D-Bus connection.");
   // Not implemented
 }
 
@@ -264,11 +271,11 @@ message_handler(DBusConnection *conn, DBusMessage *msg, void *user_data)
   return interface->HandleDBusMessage(conn, msg);
 }
 
-static DBusHandlerResult
-unregister(DBusConnection *conn, DBusMessage *msg, void *user_data)
+static void
+unregister(DBusConnection *conn, void *user_data)
 {
   auto interface = static_cast<nsGTKRemoteService*>(user_data);
-  interface->UnregisterDBusInterface();
+  interface->UnregisterDBusInterface(conn);
 }
 
 static DBusObjectPathVTable remoteHandlersTable = {
@@ -277,7 +284,7 @@ static DBusObjectPathVTable remoteHandlersTable = {
 };
 
 bool
-DBusRemoteService::Connect(const char* aAppName, const char* aProfileName)
+nsGTKRemoteService::Connect(const char* aAppName, const char* aProfileName)
 {
   mConnection = already_AddRefed<DBusConnection>(
     dbus_bus_get(DBUS_BUS_SESSION, nullptr));
@@ -310,7 +317,7 @@ DBusRemoteService::Connect(const char* aAppName, const char* aProfileName)
 }
 
 void
-DBusRemoteService::Disconnect()
+nsGTKRemoteService::Disconnect()
 {
   if (mConnection) {
     dbus_connection_unref(mConnection);
diff --git a/toolkit/components/remote/nsGTKRemoteService.h b/toolkit/components/remote/nsGTKRemoteService.h
index a2061437e8c1..638558b4398a 100644
--- a/toolkit/components/remote/nsGTKRemoteService.h
+++ b/toolkit/components/remote/nsGTKRemoteService.h
@@ -39,6 +39,9 @@ public:
 #endif    
     { }
 
+    DBusHandlerResult HandleDBusMessage(DBusConnection *aConnection, DBusMessage *msg);
+    void UnregisterDBusInterface();
+
 private:
   ~nsGTKRemoteService() { }
 
@@ -59,8 +62,6 @@ private:
 
   DBusHandlerResult OpenURL(DBusMessage *msg);
   DBusHandlerResult Introspect(DBusMessage *msg);
-  DBusHandlerResult HandleDBusMessage(DBusConnection *aConnection, DBusMessage *msg);
-  void UnregisterDBusInterface();
 
   bool Connect(const char* aAppName, const char* aProfileName);
   void Disconnect();
-- 
2.11.0

